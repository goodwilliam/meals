<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Weekly Meals</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --green:      #2d6a4f;
      --green-light:#d8f3dc;
      --green-mid:  #52b788;
      --bg:         #f0f4f1;
      --card:       #ffffff;
      --text:       #1a1a1a;
      --muted:      #6b7280;
      --border:     #e5e7eb;
      --red-bg:     #fee2e2;   --red-text:   #b91c1c;
      --yellow-bg:  #fef9c3;   --yellow-text:#854d0e;
      --veggie-bg:  #dcfce7;   --veggie-text:#15803d;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 90px;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--green);
      color: white;
      padding: 24px 16px 20px;
      text-align: center;
    }
    header h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
    header p  { font-size: 0.85rem; opacity: 0.75; margin-top: 4px; }

    /* â”€â”€ Cards â”€â”€ */
    .cards { padding: 14px 12px 0; display: flex; flex-direction: column; gap: 10px; }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
    }
    .card.rolling { animation: pop 0.25s ease; }
    @keyframes pop {
      0%   { transform: scale(1); }
      50%  { transform: scale(0.97); }
      100% { transform: scale(1); }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .day-name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--green);
    }
    .card-actions { display: flex; align-items: center; gap: 6px; }

    .reroll-btn {
      background: var(--green-light);
      color: var(--green);
      border: none;
      padding: 5px 13px;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .reroll-btn:active { background: #b7e4c7; }

    .fav-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 2px 4px;
      line-height: 1;
      opacity: 0.4;
      transition: opacity 0.15s, transform 0.15s;
    }
    .fav-btn.active { opacity: 1; }
    .fav-btn:active { transform: scale(1.3); }

    .meal-rows { display: flex; flex-direction: column; gap: 7px; }

    .meal-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.92rem;
    }
    .tag {
      font-size: 0.68rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
      min-width: 54px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      flex-shrink: 0;
    }
    .tag-p { background: var(--red-bg);    color: var(--red-text); }
    .tag-s { background: var(--yellow-bg); color: var(--yellow-text); }
    .tag-v { background: var(--veggie-bg); color: var(--veggie-text); }

    .meal-name { flex: 1; }

    .cook-note {
      margin-top: 10px;
      padding-top: 9px;
      border-top: 1px solid var(--border);
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .recipe-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 5px;
    }
    .recipe-links:only-child { margin-bottom: 0; }
    .recipe-link {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      background: var(--bg);
      color: var(--green);
      border: 1px solid var(--green-mid);
      border-radius: 12px;
      padding: 3px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      text-decoration: none;
    }
    .recipe-link:active { opacity: 0.7; }

    /* â”€â”€ Loading â”€â”€ */
    .loading-card {
      background: var(--card);
      border-radius: 14px;
      padding: 30px;
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
    }

    /* â”€â”€ Favorites section â”€â”€ */
    .fav-section {
      margin: 12px 12px 0;
      background: var(--card);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      display: none;
    }
    .fav-section.open { display: block; }
    .fav-header {
      background: #7f1d1d;
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .fav-clear {
      font-size: 0.78rem;
      opacity: 0.8;
      background: none;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      cursor: pointer;
    }
    .fav-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
    .fav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .fav-item:last-child { border-bottom: none; }
    .fav-item-name { flex: 1; }
    .fav-remove {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      opacity: 0.5;
      padding: 2px 6px;
    }
    .fav-empty {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      padding: 16px 0;
    }

    /* â”€â”€ Grocery section â”€â”€ */
    .grocery-wrap {
      margin: 12px 12px 0;
      background: var(--card);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      display: none;
    }
    .grocery-wrap.open { display: block; }

    .grocery-header {
      background: var(--green);
      color: white;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .clear-checks {
      font-size: 0.78rem;
      opacity: 0.8;
      background: none;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      cursor: pointer;
    }

    .grocery-body { padding: 14px 16px; }

    .g-category { margin-bottom: 16px; }
    .g-category:last-child { margin-bottom: 0; }
    .g-category h3 {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .g-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      font-size: 0.92rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .g-item:last-child { border-bottom: none; }
    .g-item.checked { opacity: 0.4; text-decoration: line-through; }
    .g-item input { width: 18px; height: 18px; accent-color: var(--green); cursor: pointer; }

    /* â”€â”€ Bottom bar â”€â”€ */
    .bottom-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      display: flex;
      gap: 8px;
    }
    .btn {
      flex: 1;
      padding: 13px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn:active { opacity: 0.8; }
    .btn-outline {
      background: var(--bg);
      color: var(--green);
      border: 1.5px solid var(--green-mid);
    }
    .btn-solid {
      background: var(--green);
      color: white;
    }
    .btn-fav {
      background: #fff1f2;
      color: #b91c1c;
      border: 1.5px solid #fca5a5;
    }
    .btn-danger       { background: var(--red-bg); color: var(--red-text); border: 1.5px solid #fca5a5; }
    .btn-danger-solid { background: #b91c1c; color: white; border: none; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ¥¦ Weekly Meals</h1>
  <p id="week-label"></p>
</header>

<div class="cards" id="cards">
  <div class="loading-card">Loading meals...</div>
</div>

<div class="fav-section" id="fav-section">
  <div class="fav-header">
    <span>â¤ï¸ Saved Favorites</span>
    <button class="fav-clear" onclick="clearAllFavs()">Clear all</button>
  </div>
  <div class="fav-body" id="fav-body"></div>
</div>

<div class="grocery-wrap" id="grocery-wrap">
  <div class="grocery-header">
    <span>ğŸ›’ Grocery List</span>
    <button class="clear-checks" onclick="clearChecks()">Clear checks</button>
  </div>
  <div class="grocery-body" id="grocery-body"></div>
</div>

<div class="bottom-bar" id="bottom-bar">
  <button class="btn btn-outline" onclick="askRerollAll()">ğŸ² Reroll All</button>
  <button class="btn btn-fav"     onclick="toggleFavSection()">â¤ï¸ Favs</button>
  <button class="btn btn-solid"   onclick="toggleGrocery()">ğŸ›’ List</button>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TheMealDB category metadata
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORY_META = {
  Beef:       { starches: ["White rice", "Roasted potatoes", "Mashed potatoes"], items: { Proteins: ["beef"] } },
  Chicken:    { starches: ["White rice", "Roasted potatoes"],                    items: { Proteins: ["chicken"] } },
  Seafood:    { starches: ["White rice", "Pasta"],                               items: { Proteins: ["fish / seafood"] } },
  Lamb:       { starches: ["White rice", "Roasted potatoes"],                    items: { Proteins: ["lamb"] } },
  Pork:       { starches: ["White rice", "Roasted potatoes", "Mashed potatoes"], items: { Proteins: ["pork"] } },
  Vegetarian: { starches: ["White rice", "Roasted potatoes"],                    items: { Proteins: ["chickpeas / tofu / eggs"] } },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FALLBACK DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROTEINS_FALLBACK = [
  { name: "Baked chicken thighs", starches: ["White rice", "Roasted potatoes"], note: "Season with garlic powder, paprika, salt + olive oil. Bake 425Â°F for 35 min.", items: { Proteins: ["chicken thighs"], Pantry: ["garlic powder", "paprika"], Produce: [] } },
  { name: "Pan-seared chicken breast", starches: ["White rice", "Roasted potatoes"], note: "Season with salt, pepper, garlic. Pan sear 6â€“7 min per side on medium-high.", items: { Proteins: ["chicken breast"], Pantry: ["olive oil"], Produce: ["garlic", "lemon"] } },
  { name: "Steak", starches: ["White rice", "Roasted potatoes", "Mashed potatoes"], note: "Pat dry, season generously with salt + pepper. Pan sear 3â€“4 min/side. Rest 5 min.", items: { Proteins: ["steak (sirloin or ribeye)"], Pantry: ["butter"], Produce: ["garlic"] } },
  { name: "Salmon", starches: ["White rice"], note: "Brush with soy sauce + honey. Bake 400Â°F for 12â€“14 min.", items: { Proteins: ["salmon fillets"], Pantry: ["soy sauce", "honey"], Produce: ["garlic"] } },
  { name: "Ground beef bowl", starches: ["White rice"], note: "Brown beef with diced onion + garlic. Season with cumin, salt, chili powder.", items: { Proteins: ["ground beef (1 lb)"], Pantry: ["cumin", "chili powder"], Produce: ["onion", "garlic"] } },
  { name: "Lomo Saltado", starches: ["White rice"], note: "Stir fry beef strips with onion, tomato, soy + oyster sauce over high heat.", items: { Proteins: ["beef strips (1 lb)"], Pantry: ["soy sauce", "oyster sauce"], Produce: ["onion", "tomato", "garlic"] } },
  { name: "Garlic butter shrimp", starches: ["White rice", "Pasta"], note: "SautÃ© in butter + garlic 2â€“3 min per side until pink. Squeeze lemon.", items: { Proteins: ["shrimp (1 lb)"], Pantry: ["butter"], Produce: ["garlic", "lemon"] } },
  { name: "Pork chops", starches: ["White rice", "Mashed potatoes", "Roasted potatoes"], note: "Season, pan sear 4â€“5 min per side. Let rest before cutting.", items: { Proteins: ["pork chops"], Pantry: ["garlic powder", "paprika"], Produce: [] } },
  { name: "Meat sauce pasta", starches: ["Pasta"], note: "Brown ground beef + garlic, add marinara, simmer 20 min. Great leftovers.", items: { Proteins: ["ground beef (1 lb)"], Pantry: ["jarred marinara", "pasta (1 box)"], Produce: ["garlic", "onion"] } },
  { name: "Rotisserie chicken", starches: ["White rice", "Roasted potatoes", "Mashed potatoes"], note: "Pick one up on the way home. Zero cooking. Pull the meat and serve.", items: { Proteins: ["rotisserie chicken (store-bought)"], Pantry: [], Produce: [] } },
  { name: "Chicken tacos", starches: ["White rice"], note: "Simmer chicken thighs with cumin + garlic broth 25 min, shred, serve with tortillas.", items: { Proteins: ["chicken thighs"], Pantry: ["cumin", "chili powder", "flour tortillas", "chicken broth"], Produce: ["garlic", "lime"] } },
  { name: "Ground beef tacos", starches: ["White rice"], note: "Cook ground beef with taco seasoning. Serve in tortillas.", items: { Proteins: ["ground beef (1 lb)"], Pantry: ["taco seasoning", "flour tortillas", "jarred salsa"], Produce: ["lime"] } },
];

const VEGGIES = [
  { name: "Steamed broccoli",        items: { Produce: ["broccoli"] } },
  { name: "Roasted asparagus",       items: { Produce: ["asparagus"], Pantry: ["olive oil"] } },
  { name: "SautÃ©ed green beans",     items: { Produce: ["green beans", "garlic"] } },
  { name: "Roasted zucchini",        items: { Produce: ["zucchini"], Pantry: ["olive oil"] } },
  { name: "SautÃ©ed spinach",         items: { Produce: ["baby spinach", "garlic"] } },
  { name: "Roasted bell peppers",    items: { Produce: ["bell peppers"], Pantry: ["olive oil"] } },
  { name: "Steamed corn",            items: { Produce: ["frozen corn"] } },
  { name: "Roasted carrots",         items: { Produce: ["carrots"], Pantry: ["olive oil", "honey"] } },
  { name: "Roasted Brussels sprouts",items: { Produce: ["Brussels sprouts", "garlic"], Pantry: ["olive oil"] } },
  { name: "Cucumber & tomato salad", items: { Produce: ["cucumber", "tomato", "lemon"], Pantry: ["olive oil"] } },
  { name: "Roasted sweet potato",    items: { Produce: ["sweet potato"], Pantry: ["olive oil", "cinnamon"] } },
];

const STARCH_ITEMS = {
  "White rice":       { Pantry: ["white rice"] },
  "Pasta":            { Pantry: ["pasta (1 box)"] },
  "Roasted potatoes": { Produce: ["potatoes"], Pantry: ["olive oil", "garlic powder"] },
  "Mashed potatoes":  { Produce: ["potatoes"], Dairy: ["butter", "milk"] },
};

const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let PROTEINS = PROTEINS_FALLBACK;
let plan = [];
let FAVORITES = new Set(); // set of protein names

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FAVORITES PERSISTENCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadFavorites() {
  try {
    const raw = localStorage.getItem('favorites');
    if (raw) FAVORITES = new Set(JSON.parse(raw));
  } catch (_) {}
}

function saveFavorites() {
  localStorage.setItem('favorites', JSON.stringify([...FAVORITES]));
}

function toggleFavorite(i) {
  const name = plan[i].protein.name;
  if (FAVORITES.has(name)) {
    FAVORITES.delete(name);
  } else {
    FAVORITES.add(name);
  }
  saveFavorites();
  render();
  if (document.getElementById('fav-section').classList.contains('open')) buildFavSection();
}

function clearAllFavs() {
  FAVORITES.clear();
  saveFavorites();
  buildFavSection();
  render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TheMealDB FETCH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMealPool() {
  try {
    const categories = Object.keys(CATEGORY_META);
    const results = await Promise.all(
      categories.map(cat =>
        fetch(`https://www.themealdb.com/api/json/v1/1/filter.php?c=${cat}`)
          .then(r => r.json())
          .then(d => (d.meals || []).map(m => ({
            name: m.strMeal,
            starches: CATEGORY_META[cat].starches,
            note: '',
            items: CATEGORY_META[cat].items,
            mealId: m.idMeal,
          })))
          .catch(() => [])
      )
    );
    const all = results.flat();
    if (all.length > 0) PROTEINS = all;
  } catch (_) {}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function makeMeal() {
  const protein = rand(PROTEINS);
  return { protein, starch: rand(protein.starches), veggie: rand(VEGGIES) };
}

function render() {
  const d = new Date();
  document.getElementById('week-label').textContent =
    'Week of ' + d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

  const container = document.getElementById('cards');
  container.innerHTML = '';

  plan.forEach((meal, i) => {
    const isFav = FAVORITES.has(meal.protein.name);
    const recipeUrl = meal.protein.mealId
      ? `https://www.themealdb.com/meal/${meal.protein.mealId}`
      : null;
    const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(meal.protein.name + ' recipe')}`;

    const linksHtml = `
      <div class="recipe-links">
        ${recipeUrl ? `<a href="${recipeUrl}" target="_blank" class="recipe-link">ğŸ“– Recipe</a>` : ''}
        <a href="${ytUrl}" target="_blank" class="recipe-link">â–¶ YouTube</a>
      </div>
    `;
    const noteHtml = meal.protein.note
      ? `<div style="margin-top:4px">${meal.protein.note}</div>`
      : '';

    const card = document.createElement('div');
    card.className = 'card';
    card.id = `card-${i}`;
    card.innerHTML = `
      <div class="card-header">
        <span class="day-name">${DAYS[i]}</span>
        <div class="card-actions">
          <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite(${i})" title="${isFav ? 'Remove favorite' : 'Save as favorite'}">â¤ï¸</button>
          <button class="reroll-btn" onclick="rerollDay(${i})">ğŸ² Reroll</button>
        </div>
      </div>
      <div class="meal-rows">
        <div class="meal-row">
          <span class="tag tag-p">Protein</span>
          <span class="meal-name">${meal.protein.name}</span>
        </div>
        <div class="meal-row">
          <span class="tag tag-s">Starch</span>
          <span class="meal-name">${meal.starch}</span>
        </div>
        <div class="meal-row">
          <span class="tag tag-v">Veggie</span>
          <span class="meal-name">${meal.veggie.name}</span>
        </div>
      </div>
      <div class="cook-note">${linksHtml}${noteHtml}</div>
    `;
    container.appendChild(card);
  });

  save();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rerollConfirmTimeout = null;

function askRerollAll() {
  clearTimeout(rerollConfirmTimeout);
  document.getElementById('bottom-bar').innerHTML = `
    <button class="btn btn-danger"       onclick="cancelRerollAll()">âœ• Cancel</button>
    <button class="btn btn-danger-solid" onclick="doRerollAll()">Reset all meals?</button>
  `;
  rerollConfirmTimeout = setTimeout(cancelRerollAll, 4000);
}

function cancelRerollAll() {
  clearTimeout(rerollConfirmTimeout);
  restoreBottomBar();
}

function doRerollAll() {
  clearTimeout(rerollConfirmTimeout);
  restoreBottomBar();
  plan = DAYS.map(() => makeMeal());
  render();
  closeGrocery();
}

function restoreBottomBar() {
  document.getElementById('bottom-bar').innerHTML = `
    <button class="btn btn-outline" onclick="askRerollAll()">ğŸ² Reroll All</button>
    <button class="btn btn-fav"     onclick="toggleFavSection()">â¤ï¸ Favs</button>
    <button class="btn btn-solid"   onclick="toggleGrocery()">ğŸ›’ List</button>
  `;
}

function rerollDay(i) {
  plan[i] = makeMeal();
  render();
  setTimeout(() => {
    const card = document.getElementById(`card-${i}`);
    if (card) { card.classList.add('rolling'); setTimeout(() => card.classList.remove('rolling'), 300); }
  }, 10);
  if (document.getElementById('grocery-wrap').classList.contains('open')) buildGrocery();
}

// â”€â”€ Favorites section â”€â”€
function toggleFavSection() {
  const el = document.getElementById('fav-section');
  if (el.classList.contains('open')) {
    el.classList.remove('open');
  } else {
    buildFavSection();
    el.classList.add('open');
    setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
  }
}

function buildFavSection() {
  const body = document.getElementById('fav-body');
  if (FAVORITES.size === 0) {
    body.innerHTML = '<div class="fav-empty">No favorites yet â€” tap â¤ï¸ on a meal to save it.</div>';
    return;
  }
  body.innerHTML = '';
  [...FAVORITES].sort().forEach(name => {
    const row = document.createElement('div');
    row.className = 'fav-item';
    row.innerHTML = `
      <span class="fav-item-name">â¤ï¸ ${name}</span>
      <button class="fav-remove" onclick="removeFav('${name.replace(/'/g, "\\'")}')">âœ•</button>
    `;
    body.appendChild(row);
  });
}

function removeFav(name) {
  FAVORITES.delete(name);
  saveFavorites();
  buildFavSection();
  render();
}

// â”€â”€ Grocery â”€â”€
function toggleGrocery() {
  const wrap = document.getElementById('grocery-wrap');
  if (wrap.classList.contains('open')) {
    closeGrocery();
  } else {
    buildGrocery();
    wrap.classList.add('open');
    setTimeout(() => wrap.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
  }
}

function closeGrocery() {
  document.getElementById('grocery-wrap').classList.remove('open');
}

function buildGrocery() {
  const lists = { Proteins: new Set(), Produce: new Set(), Pantry: new Set(), Dairy: new Set() };

  plan.forEach(meal => {
    Object.entries(meal.protein.items).forEach(([cat, items]) => items.forEach(i => lists[cat]?.add(i)));
    const starchItems = STARCH_ITEMS[meal.starch] || {};
    Object.entries(starchItems).forEach(([cat, items]) => items.forEach(i => lists[cat]?.add(i)));
    Object.entries(meal.veggie.items).forEach(([cat, items]) => items.forEach(i => lists[cat]?.add(i)));
  });

  lists.Pantry.add('olive oil');
  lists.Pantry.add('salt');
  lists.Pantry.add('pepper');

  const body = document.getElementById('grocery-body');
  body.innerHTML = '';

  const catLabels = { Proteins: 'Proteins & Fish', Produce: 'Produce', Pantry: 'Pantry & Spices', Dairy: 'Dairy' };

  for (const [cat, label] of Object.entries(catLabels)) {
    const items = [...lists[cat]].filter(Boolean).sort();
    if (!items.length) continue;
    const div = document.createElement('div');
    div.className = 'g-category';
    div.innerHTML = `<h3>${label}</h3>`;
    items.forEach(item => {
      const row = document.createElement('label');
      row.className = 'g-item';
      row.innerHTML = `<input type="checkbox" onchange="this.closest('.g-item').classList.toggle('checked', this.checked)"><span>${item}</span>`;
      div.appendChild(row);
    });
    body.appendChild(div);
  }
}

function clearChecks() {
  document.querySelectorAll('.g-item').forEach(el => {
    el.classList.remove('checked');
    el.querySelector('input').checked = false;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PERSISTENCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() {
  const data = plan.map(m => ({
    protein: { name: m.protein.name, starches: m.protein.starches, note: m.protein.note, items: m.protein.items, mealId: m.protein.mealId },
    starch: m.starch,
    veggie: { name: m.veggie.name, items: m.veggie.items },
  }));
  localStorage.setItem('mealPlan', JSON.stringify({ date: new Date().toDateString(), data }));
}

function load() {
  try {
    const raw = localStorage.getItem('mealPlan');
    if (!raw) return false;
    const { date, data } = JSON.parse(raw);
    if (date !== new Date().toDateString()) return false;
    if (!data[0]?.protein?.name) return false;
    plan = data.map(d => ({ protein: d.protein, starch: d.starch, veggie: d.veggie }));
    return true;
  } catch { return false; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  loadFavorites();
  await fetchMealPool();
  if (!load()) { plan = DAYS.map(() => makeMeal()); }
  render();
})();
</script>
</body>
</html>
